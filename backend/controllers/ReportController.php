<?phpnamespace backend\controllers;use appxq\sdii\utils\SDUtility;use appxq\sdii\utils\VarDumper;use backend\classes\BillManager;use backend\models\Commissions;use backend\models\UserSippings;use yii\db\Expression;use yii\web\Controller;class ReportController extends Controller{    public function actionCustomerCar(){        return $this->render("customer-car");    }    public function actionCustomerCarData(){        $stdate = \Yii::$app->request->post('stdate');        $endate = \Yii::$app->request->post('endate');        $userAll = UserSippings::find()->where('type not in(99) AND rstat not in(0,3)')->all();        $output = [];        foreach($userAll as $k=>$u){            $bills = BillManager::reportCustomerCar($u['bill_id']);            $output[] = $bills;        }        $token = SDUtility::getMillisecTime();        $customers = [];        $user_id = '';        $price = 0;        foreach($output as $k=>$bill){           foreach($bill as $k2=>$v){               $com = new Commissions();               $com->bill_id = $v['bill_id'];               $com->user_id = $v['user_id'];               $com->driver = $v['driver'];               $com->status = (string)$v['status'];               $com->price = $v['price'];               $com->position = $v['position'];               $com->token = $token;               $com->create_date = new Expression('NOW()');               if(!$com->save()){                   VarDumper::dump($com->errors);               }           }        }        $sql="            SELECT  *,                (SELECT sum(price) FROM commissions WHERE user_id=c.user_id AND token = c.token) as sum                 FROM commissions as c WHERE token = :token GROUP BY user_id;        ";        $data = \Yii::$app->db->createCommand($sql,[':token'=>$token])->queryAll();        return $this->render('customer-car',[            'data'=>$data        ]);    }}